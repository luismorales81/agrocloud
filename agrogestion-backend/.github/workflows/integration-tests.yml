name: Pruebas de IntegraciÃ³n y RegresiÃ³n

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  MYSQL_VERSION: '8.0'
  MYSQL_ROOT_PASSWORD: 'root'
  MYSQL_DATABASE: 'agrocloud_test'
  MYSQL_USER: 'testuser'
  MYSQL_PASSWORD: 'testpass'

jobs:
  # Job para pruebas de integraciÃ³n
  integration-tests:
    name: Pruebas de IntegraciÃ³n REST
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:${{ env.MYSQL_VERSION }}
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -p${{ env.MYSQL_ROOT_PASSWORD }}"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache dependencias Maven
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Verificar conexiÃ³n a MySQL
      run: |
        echo "Verificando conexiÃ³n a MySQL..."
        mysql -h 127.0.0.1 -P 3306 -u ${{ env.MYSQL_USER }} -p${{ env.MYSQL_PASSWORD }} -e "SELECT 1;" ${{ env.MYSQL_DATABASE }}

    - name: Ejecutar pruebas de integraciÃ³n
      run: |
        echo "ğŸš€ Ejecutando pruebas de integraciÃ³n..."
        ./mvnw clean test -Dtest=IntegrationTestSuite -Dspring.profiles.active=test
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/${{ env.MYSQL_DATABASE }}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
        SPRING_DATASOURCE_USERNAME: ${{ env.MYSQL_USER }}
        SPRING_DATASOURCE_PASSWORD: ${{ env.MYSQL_PASSWORD }}

    - name: Generar reporte de cobertura
      run: |
        echo "ğŸ“Š Generando reporte de cobertura..."
        ./mvnw jacoco:report

    - name: Subir reporte de cobertura
      uses: codecov/codecov-action@v3
      with:
        file: ./target/site/jacoco/jacoco.xml
        flags: integration-tests
        name: integration-tests-coverage

    - name: Publicar resultados de pruebas
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Resultados de Pruebas de IntegraciÃ³n
        path: target/surefire-reports/*.xml
        reporter: java-junit

  # Job para pruebas de regresiÃ³n
  regression-tests:
    name: Pruebas de RegresiÃ³n
    runs-on: ubuntu-latest
    needs: integration-tests
    
    services:
      mysql:
        image: mysql:${{ env.MYSQL_VERSION }}
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -p${{ env.MYSQL_ROOT_PASSWORD }}"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache dependencias Maven
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Ejecutar todas las pruebas
      run: |
        echo "ğŸ”„ Ejecutando pruebas de regresiÃ³n completas..."
        ./mvnw clean test -Dspring.profiles.active=test
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/${{ env.MYSQL_DATABASE }}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
        SPRING_DATASOURCE_USERNAME: ${{ env.MYSQL_USER }}
        SPRING_DATASOURCE_PASSWORD: ${{ env.MYSQL_PASSWORD }}

    - name: Verificar resultados de pruebas
      run: |
        echo "âœ… Verificando resultados de pruebas..."
        if [ -f target/surefire-reports/TEST-*.xml ]; then
          echo "ğŸ“‹ Reportes de pruebas encontrados:"
          ls -la target/surefire-reports/
        else
          echo "âŒ No se encontraron reportes de pruebas"
          exit 1
        fi

    - name: Generar reporte de regresiÃ³n
      run: |
        echo "ğŸ“ˆ Generando reporte de regresiÃ³n..."
        ./mvnw jacoco:report
        
        # Crear reporte personalizado
        echo "# Reporte de Pruebas de RegresiÃ³n" > regression-report.md
        echo "## Fecha: $(date)" >> regression-report.md
        echo "## Commit: ${{ github.sha }}" >> regression-report.md
        echo "## Branch: ${{ github.ref_name }}" >> regression-report.md
        echo "" >> regression-report.md
        echo "### Resumen de Pruebas:" >> regression-report.md
        echo "- âœ… Pruebas de integraciÃ³n: COMPLETADAS" >> regression-report.md
        echo "- âœ… Pruebas de regresiÃ³n: COMPLETADAS" >> regression-report.md
        echo "- âœ… Cobertura de cÃ³digo: GENERADA" >> regression-report.md

    - name: Subir reporte de regresiÃ³n
      uses: actions/upload-artifact@v3
      with:
        name: regression-report
        path: |
          regression-report.md
          target/site/jacoco/
          target/surefire-reports/

  # Job para validaciÃ³n de calidad
  quality-gate:
    name: ValidaciÃ³n de Calidad
    runs-on: ubuntu-latest
    needs: [integration-tests, regression-tests]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache dependencias Maven
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: AnÃ¡lisis de calidad con SonarQube
      run: |
        echo "ğŸ” Ejecutando anÃ¡lisis de calidad..."
        ./mvnw clean compile sonar:sonar \
          -Dsonar.projectKey=agrogestion-backend \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Verificar calidad del cÃ³digo
      run: |
        echo "ğŸ“Š Verificando mÃ©tricas de calidad..."
        # AquÃ­ se pueden agregar verificaciones adicionales
        echo "âœ… AnÃ¡lisis de calidad completado"

  # Job para notificaciones
  notify:
    name: Notificaciones
    runs-on: ubuntu-latest
    needs: [integration-tests, regression-tests, quality-gate]
    if: always()
    
    steps:
    - name: Notificar resultados
      run: |
        echo "ğŸ“¢ Enviando notificaciones..."
        
        if [ "${{ needs.integration-tests.result }}" == "success" ] && 
           [ "${{ needs.regression-tests.result }}" == "success" ] && 
           [ "${{ needs.quality-gate.result }}" == "success" ]; then
          echo "âœ… Todas las pruebas pasaron exitosamente"
          echo "ğŸš€ El cÃ³digo estÃ¡ listo para merge"
        else
          echo "âŒ Algunas pruebas fallaron"
          echo "ğŸ›‘ El merge estÃ¡ bloqueado"
          exit 1
        fi

  # Job para deployment (solo en main)
  deploy:
    name: Deployment
    runs-on: ubuntu-latest
    needs: [integration-tests, regression-tests, quality-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Build aplicaciÃ³n
      run: |
        echo "ğŸ—ï¸ Construyendo aplicaciÃ³n..."
        ./mvnw clean package -DskipTests

    - name: Deploy a producciÃ³n
      run: |
        echo "ğŸš€ Desplegando a producciÃ³n..."
        # AquÃ­ se agregarÃ­an los comandos de deployment especÃ­ficos
        echo "âœ… Deployment completado"
